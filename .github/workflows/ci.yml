# CI Pipeline for lorenzos-claude-code Plugin
# Validates plugin structure, syntax, and documentation

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validate Plugin
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate plugin.json
        run: |
          echo "Validating plugin.json syntax..."
          node -e "JSON.parse(require('fs').readFileSync('.claude-plugin/plugin.json'))"
          echo "plugin.json is valid JSON"

      - name: Validate plugin structure
        run: |
          echo "Checking required files..."
          test -f .claude-plugin/plugin.json && echo "plugin.json exists"
          test -f CLAUDE.md && echo "CLAUDE.md exists"
          test -d .claude/commands && echo "commands directory exists"
          test -d .claude/agents && echo "agents directory exists"
          test -d .claude/skills && echo "skills directory exists"
          echo "All required files present!"

      - name: Count components
        run: |
          echo "Plugin Component Summary:"
          echo "========================="
          echo "Commands: $(find .claude/commands -name '*.md' | wc -l | tr -d ' ')"
          echo "Agents: $(find .claude/agents -name '*.md' | wc -l | tr -d ' ')"
          echo "Skills: $(find .claude/skills -name '*.md' | wc -l | tr -d ' ')"
          echo "Orchestrators: $(find .claude/orchestrators -name '*.md' 2>/dev/null | wc -l | tr -d ' ')"
          echo "Hooks: $(find .claude/hooks -name '*.sh' 2>/dev/null | wc -l | tr -d ' ')"

      - name: Validate frontmatter
        run: |
          echo "Checking command frontmatter..."
          for file in $(find .claude/commands -name '*.md'); do
            if head -1 "$file" | grep -q '^---$'; then
              echo "OK: $file"
            else
              echo "FAIL: $file missing frontmatter"
              exit 1
            fi
          done
          echo "All commands have valid frontmatter!"

  markdown-lint:
    name: Lint Markdown
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint
        run: npm install -g markdownlint-cli

      - name: Lint documentation
        run: markdownlint README.md CLAUDE.md CHANGELOG.md --disable MD013 MD033 MD041 || true
