name: Scheduled Dependency Audit

on:
  schedule:
    # Run biweekly on Mondays at 09:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: '20'

      - name: Check for package.json
        id: check_package
        run: |
          if [ -f "package.json" ]; then
            echo "has_package=true" >> $GITHUB_OUTPUT
          else
            echo "has_package=false" >> $GITHUB_OUTPUT
            echo "No package.json found - skipping npm audit"
          fi

      - name: Install dependencies
        if: steps.check_package.outputs.has_package == 'true'
        run: npm ci --ignore-scripts

      - name: Run npm audit
        if: steps.check_package.outputs.has_package == 'true'
        id: audit
        continue-on-error: true
        run: |
          npm audit --json > audit-report.json || true

          # Parse audit results
          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-report.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-report.json)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit-report.json)
          LOW=$(jq '.metadata.vulnerabilities.low // 0' audit-report.json)

          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT

          echo "## NPM Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| High | $HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| Moderate | $MODERATE |" >> $GITHUB_STEP_SUMMARY
          echo "| Low | $LOW |" >> $GITHUB_STEP_SUMMARY

      - name: Check MCP server versions
        run: |
          echo "## MCP Server Version Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Checking for latest MCP server versions..." >> $GITHUB_STEP_SUMMARY

          # Extract MCP servers from .mcp.json
          if [ -f ".mcp.json" ]; then
            echo "Found .mcp.json - checking server configurations" >> $GITHUB_STEP_SUMMARY

            # List configured servers
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Configured MCP Servers" >> $GITHUB_STEP_SUMMARY
            jq -r '.mcpServers | keys[]' .mcp.json 2>/dev/null | while read server; do
              echo "- $server" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "No .mcp.json found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check hook script permissions
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Hook Script Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          ISSUES=0
          for hook in .claude/hooks/*.sh; do
            if [ -f "$hook" ]; then
              if [ ! -x "$hook" ]; then
                echo "::warning file=$hook::Hook script is not executable"
                echo "- âš ï¸ $hook is not executable" >> $GITHUB_STEP_SUMMARY
                ISSUES=$((ISSUES + 1))
              else
                echo "- âœ… $hook" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

          if [ $ISSUES -eq 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All hook scripts are properly configured." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create issue for critical vulnerabilities
        if: steps.audit.outputs.critical > 0 || steps.audit.outputs.high > 0
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            const critical = ${{ steps.audit.outputs.critical || 0 }};
            const high = ${{ steps.audit.outputs.high || 0 }};

            const title = `ðŸ”’ Security: ${critical} critical, ${high} high vulnerabilities found`;
            const body = `## Automated Security Audit Report

            The scheduled dependency audit found security vulnerabilities:

            | Severity | Count |
            |----------|-------|
            | Critical | ${critical} |
            | High | ${high} |
            | Moderate | ${{ steps.audit.outputs.moderate || 0 }} |
            | Low | ${{ steps.audit.outputs.low || 0 }} |

            ### Recommended Actions

            1. Run \`npm audit fix\` to auto-fix compatible updates
            2. Run \`npm audit fix --force\` for breaking changes (review carefully)
            3. Manually update packages that cannot be auto-fixed

            ---
            *This issue was automatically created by the scheduled dependency audit workflow.*`;

            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,automated'
            });

            const existingIssue = issues.data.find(i => i.title.includes('Security:'));

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'automated']
              });
            }
