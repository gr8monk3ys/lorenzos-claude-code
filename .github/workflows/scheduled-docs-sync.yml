name: Scheduled Documentation Sync

on:
  schedule:
    # Run monthly on the 1st at 00:00 UTC
    - cron: '0 0 1 * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no changes)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  docs-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: '20'

      - name: Count components
        id: count
        run: |
          COMMANDS=$(find .claude/commands -name "*.md" -type f | wc -l)
          AGENTS=$(find .claude/agents -name "*.md" -type f | wc -l)
          SKILLS=$(find .claude/skills -name "*.md" -type f | wc -l)
          HOOKS=$(find .claude/hooks -name "*.sh" -type f | wc -l)

          echo "commands=$COMMANDS" >> $GITHUB_OUTPUT
          echo "agents=$AGENTS" >> $GITHUB_OUTPUT
          echo "skills=$SKILLS" >> $GITHUB_OUTPUT
          echo "hooks=$HOOKS" >> $GITHUB_OUTPUT

          echo "## Component Counts" >> $GITHUB_STEP_SUMMARY
          echo "- Commands: $COMMANDS" >> $GITHUB_STEP_SUMMARY
          echo "- Agents: $AGENTS" >> $GITHUB_STEP_SUMMARY
          echo "- Skills: $SKILLS" >> $GITHUB_STEP_SUMMARY
          echo "- Hooks: $HOOKS" >> $GITHUB_STEP_SUMMARY

      - name: Check for outdated documentation
        id: check_docs
        run: |
          # Check if README mentions correct counts
          README_COMMANDS=$(grep -oP '\*\*\d+\s+slash commands\*\*' README.md | grep -oP '\d+' || echo "0")
          ACTUAL_COMMANDS=${{ steps.count.outputs.commands }}

          if [ "$README_COMMANDS" != "$ACTUAL_COMMANDS" ]; then
            echo "outdated=true" >> $GITHUB_OUTPUT
            echo "::warning::README.md shows $README_COMMANDS commands but found $ACTUAL_COMMANDS"
          else
            echo "outdated=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate all command files
        run: |
          echo "## Validating Commands" >> $GITHUB_STEP_SUMMARY
          ERRORS=0
          for file in .claude/commands/**/*.md; do
            if [ -f "$file" ]; then
              # Check for required frontmatter
              if ! grep -q "^---" "$file"; then
                echo "::error file=$file::Missing frontmatter"
                ERRORS=$((ERRORS + 1))
              fi
              # Check for $ARGUMENTS placeholder
              if ! grep -q '\$ARGUMENTS' "$file"; then
                echo "::warning file=$file::Missing \$ARGUMENTS placeholder"
              fi
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            echo "- Found $ERRORS errors in command files" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "- All command files validated successfully" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Validate all agent files
        run: |
          echo "## Validating Agents" >> $GITHUB_STEP_SUMMARY
          ERRORS=0
          for file in .claude/agents/*.md; do
            if [ -f "$file" ]; then
              if ! grep -q "^---" "$file"; then
                echo "::error file=$file::Missing frontmatter"
                ERRORS=$((ERRORS + 1))
              fi
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            echo "- Found $ERRORS errors in agent files" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "- All agent files validated successfully" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create sync report
        if: steps.check_docs.outputs.outdated == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          echo "Documentation may need updating. Review the workflow summary for details."
